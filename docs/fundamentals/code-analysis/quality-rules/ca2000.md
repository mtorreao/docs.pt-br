---
title: 'CA2000: descartar objetos antes de perder o escopo (análise de código)'
description: 'Saiba mais sobre a regra de análise de código CA2000: descartar objetos antes de perder o escopo'
ms.date: 05/14/2019
ms.topic: reference
f1_keywords:
- CA2000
- Dispose objects before losing scope
- DisposeObjectsBeforeLosingScope
helpviewer_keywords:
- CA2000
- DisposeObjectsBeforeLosingScope
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
- VB
ms.openlocfilehash: ef29091e9d78dd51abd539d3f185434a71b57138
ms.sourcegitcommit: e301979e3049ce412d19b094c60ed95b316a8f8c
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/16/2020
ms.locfileid: "97593780"
---
# <a name="ca2000-dispose-objects-before-losing-scope"></a><span data-ttu-id="66a2b-103">CA2000: Descartar objetos antes de perder o escopo</span><span class="sxs-lookup"><span data-stu-id="66a2b-103">CA2000: Dispose objects before losing scope</span></span>

| | <span data-ttu-id="66a2b-104">Valor</span><span class="sxs-lookup"><span data-stu-id="66a2b-104">Value</span></span> |
|-|-|
| <span data-ttu-id="66a2b-105">**ID da regra**</span><span class="sxs-lookup"><span data-stu-id="66a2b-105">**Rule ID**</span></span> |<span data-ttu-id="66a2b-106">CA2000</span><span class="sxs-lookup"><span data-stu-id="66a2b-106">CA2000</span></span>|
| <span data-ttu-id="66a2b-107">**Categoria**</span><span class="sxs-lookup"><span data-stu-id="66a2b-107">**Category**</span></span> |<span data-ttu-id="66a2b-108">Microsoft. confiabilidade</span><span class="sxs-lookup"><span data-stu-id="66a2b-108">Microsoft.Reliability</span></span>|
| <span data-ttu-id="66a2b-109">**A correção está sendo interrompida ou não está sendo interrompida**</span><span class="sxs-lookup"><span data-stu-id="66a2b-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="66a2b-110">Sem interrupção</span><span class="sxs-lookup"><span data-stu-id="66a2b-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="66a2b-111">Causa</span><span class="sxs-lookup"><span data-stu-id="66a2b-111">Cause</span></span>

<span data-ttu-id="66a2b-112">Um objeto local de um <xref:System.IDisposable> tipo é criado, mas o objeto não é descartado antes que todas as referências ao objeto estejam fora do escopo.</span><span class="sxs-lookup"><span data-stu-id="66a2b-112">A local object of an <xref:System.IDisposable> type is created, but the object is not disposed before all references to the object are out of scope.</span></span>

<span data-ttu-id="66a2b-113">Por padrão, essa regra analisa toda a base de código, mas é [configurável](#configure-code-to-analyze).</span><span class="sxs-lookup"><span data-stu-id="66a2b-113">By default, this rule analyzes the entire codebase, but this is [configurable](#configure-code-to-analyze).</span></span>

## <a name="rule-description"></a><span data-ttu-id="66a2b-114">Descrição da regra</span><span class="sxs-lookup"><span data-stu-id="66a2b-114">Rule description</span></span>

<span data-ttu-id="66a2b-115">Se um objeto descartável não for explicitamente descartado antes que todas as referências a ele estejam fora do escopo, o objeto será descartado em algum momento indeterminado quando o coletor de lixo executar o finalizador do objeto.</span><span class="sxs-lookup"><span data-stu-id="66a2b-115">If a disposable object is not explicitly disposed before all references to it are out of scope, the object will be disposed at some indeterminate time when the garbage collector runs the finalizer of the object.</span></span> <span data-ttu-id="66a2b-116">Como pode ocorrer um evento excepcional que impedirá que o finalizador do objeto seja executado, o objeto deve ser explicitamente descartado em vez disso.</span><span class="sxs-lookup"><span data-stu-id="66a2b-116">Because an exceptional event might occur that will prevent the finalizer of the object from running, the object should be explicitly disposed instead.</span></span>

## <a name="special-cases"></a><span data-ttu-id="66a2b-117">Casos especiais</span><span class="sxs-lookup"><span data-stu-id="66a2b-117">Special cases</span></span>

<span data-ttu-id="66a2b-118">A regra CA2000 não é acionada para objetos locais dos seguintes tipos, mesmo que o objeto não seja descartado:</span><span class="sxs-lookup"><span data-stu-id="66a2b-118">Rule CA2000 does not fire for local objects of the following types even if the object is not disposed:</span></span>

- <xref:System.IO.Stream?displayProperty=nameWithType>
- <xref:System.IO.StringReader?displayProperty=nameWithType>
- <xref:System.IO.TextReader?displayProperty=nameWithType>
- <xref:System.IO.TextWriter?displayProperty=nameWithType>
- <xref:System.Resources.IResourceReader?displayProperty=nameWithType>

<span data-ttu-id="66a2b-119">Passar um objeto de um desses tipos para um construtor e, em seguida, atribuí-lo a um campo indica uma *transferência de propriedade de descarte* para o tipo recém-criado.</span><span class="sxs-lookup"><span data-stu-id="66a2b-119">Passing an object of one of these types to a constructor and then assigning it to a field indicates a *dispose ownership transfer* to the newly constructed type.</span></span> <span data-ttu-id="66a2b-120">Ou seja, o tipo recém-criado agora é responsável por descartar o objeto.</span><span class="sxs-lookup"><span data-stu-id="66a2b-120">That is, the newly constructed type is now responsible for disposing of the object.</span></span> <span data-ttu-id="66a2b-121">Se o seu código passar um objeto de um desses tipos para um construtor, nenhuma violação da regra CA2000 ocorrerá mesmo que o objeto não seja descartado antes que todas as referências a ele fiquem fora do escopo.</span><span class="sxs-lookup"><span data-stu-id="66a2b-121">If your code passes an object of one of these types to a constructor, no violation of rule CA2000 occurs even if the object is not disposed before all references to it are out of scope.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="66a2b-122">Como corrigir violações</span><span class="sxs-lookup"><span data-stu-id="66a2b-122">How to fix violations</span></span>

<span data-ttu-id="66a2b-123">Para corrigir uma violação dessa regra, chame <xref:System.IDisposable.Dispose%2A> no objeto antes que todas as referências a ele estejam fora do escopo.</span><span class="sxs-lookup"><span data-stu-id="66a2b-123">To fix a violation of this rule, call <xref:System.IDisposable.Dispose%2A> on the object before all references to it are out of scope.</span></span>

<span data-ttu-id="66a2b-124">Você pode usar a [ `using` instrução](../../../csharp/language-reference/keywords/using-statement.md) ( [`Using`](../../../visual-basic/language-reference/statements/using-statement.md) em Visual Basic) para encapsular objetos que implementam <xref:System.IDisposable> .</span><span class="sxs-lookup"><span data-stu-id="66a2b-124">You can use the [`using` statement](../../../csharp/language-reference/keywords/using-statement.md) ([`Using`](../../../visual-basic/language-reference/statements/using-statement.md) in Visual Basic) to wrap objects that implement <xref:System.IDisposable>.</span></span> <span data-ttu-id="66a2b-125">Os objetos que são encapsulados dessa maneira são automaticamente descartados no final do `using` bloco.</span><span class="sxs-lookup"><span data-stu-id="66a2b-125">Objects that are wrapped in this manner are automatically disposed at the end of the `using` block.</span></span> <span data-ttu-id="66a2b-126">No entanto, as seguintes situações não devem ou não ser manipuladas com uma `using` instrução:</span><span class="sxs-lookup"><span data-stu-id="66a2b-126">However, the following situations should not or cannot be handled with a `using` statement:</span></span>

- <span data-ttu-id="66a2b-127">Para retornar um objeto descartável, o objeto deve ser construído em um `try/finally` bloco fora de um `using` bloco.</span><span class="sxs-lookup"><span data-stu-id="66a2b-127">To return a disposable object, the object must constructed in a `try/finally` block outside of a `using` block.</span></span>

- <span data-ttu-id="66a2b-128">Não inicializar membros de um objeto descartável no construtor de uma `using` instrução.</span><span class="sxs-lookup"><span data-stu-id="66a2b-128">Do not initialize members of a disposable object in the constructor of a `using` statement.</span></span>

- <span data-ttu-id="66a2b-129">Quando os construtores que são protegidos por apenas um manipulador de exceção são aninhados na [parte de aquisição de uma `using` instrução](../../../csharp/language-reference/keywords/using-statement.md), uma falha no Construtor externo pode fazer com que o objeto criado pelo Construtor aninhado nunca seja fechado.</span><span class="sxs-lookup"><span data-stu-id="66a2b-129">When constructors that are protected by only one exception handler are nested in the [acquisition part of a `using` statement](../../../csharp/language-reference/keywords/using-statement.md), a failure in the outer constructor can result in the object created by the nested constructor never being closed.</span></span> <span data-ttu-id="66a2b-130">No exemplo a seguir, uma falha no <xref:System.IO.StreamReader> Construtor pode fazer com que o <xref:System.IO.FileStream> objeto nunca seja fechado.</span><span class="sxs-lookup"><span data-stu-id="66a2b-130">In the following example, a failure in the <xref:System.IO.StreamReader> constructor can result in the <xref:System.IO.FileStream> object never being closed.</span></span> <span data-ttu-id="66a2b-131">CA2000 sinaliza uma violação da regra nesse caso.</span><span class="sxs-lookup"><span data-stu-id="66a2b-131">CA2000 flags a violation of the rule in this case.</span></span>

   ```csharp
   using (StreamReader sr = new StreamReader(new FileStream("C:\myfile.txt", FileMode.Create)))
   { ... }
   ```

- <span data-ttu-id="66a2b-132">Objetos dinâmicos devem usar um objeto Shadow para implementar o padrão Dispose de <xref:System.IDisposable> objetos.</span><span class="sxs-lookup"><span data-stu-id="66a2b-132">Dynamic objects should use a shadow object to implement the dispose pattern of <xref:System.IDisposable> objects.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="66a2b-133">Quando suprimir avisos</span><span class="sxs-lookup"><span data-stu-id="66a2b-133">When to suppress warnings</span></span>

<span data-ttu-id="66a2b-134">Não suprimir um aviso desta regra, a menos que:</span><span class="sxs-lookup"><span data-stu-id="66a2b-134">Do not suppress a warning from this rule unless:</span></span>

- <span data-ttu-id="66a2b-135">Você chamou um método em seu objeto que chama `Dispose` , como <xref:System.IO.Stream.Close%2A></span><span class="sxs-lookup"><span data-stu-id="66a2b-135">You've called a method on your object that calls `Dispose`, such as <xref:System.IO.Stream.Close%2A></span></span>
- <span data-ttu-id="66a2b-136">O método que gerou o aviso retorna um <xref:System.IDisposable> objeto que encapsula o objeto</span><span class="sxs-lookup"><span data-stu-id="66a2b-136">The method that raised the warning returns an <xref:System.IDisposable> object that wraps your object</span></span>
- <span data-ttu-id="66a2b-137">O método de alocação não tem a propriedade Dispose; ou seja, a responsabilidade de descartar o objeto é transferida para outro objeto ou wrapper que é criado no método e retornado ao chamador</span><span class="sxs-lookup"><span data-stu-id="66a2b-137">The allocating method does not have dispose ownership; that is, the responsibility to dispose the object is transferred to another object or wrapper that's created in the method and returned to the caller</span></span>

## <a name="configure-code-to-analyze"></a><span data-ttu-id="66a2b-138">Configurar o código para analisar</span><span class="sxs-lookup"><span data-stu-id="66a2b-138">Configure code to analyze</span></span>

<span data-ttu-id="66a2b-139">Use as opções a seguir para configurar em quais partes de sua base de código executar essa regra.</span><span class="sxs-lookup"><span data-stu-id="66a2b-139">Use the following options to configure which parts of your codebase to run this rule on.</span></span>

- [<span data-ttu-id="66a2b-140">Excluir símbolos específicos</span><span class="sxs-lookup"><span data-stu-id="66a2b-140">Exclude specific symbols</span></span>](#exclude-specific-symbols)
- [<span data-ttu-id="66a2b-141">Excluir tipos específicos e seus tipos derivados</span><span class="sxs-lookup"><span data-stu-id="66a2b-141">Exclude specific types and their derived types</span></span>](#exclude-specific-types-and-their-derived-types)

<span data-ttu-id="66a2b-142">Você pode configurar essas opções apenas para essa regra, para todas as regras ou para todas as regras nesta categoria (confiabilidade).</span><span class="sxs-lookup"><span data-stu-id="66a2b-142">You can configure these options for just this rule, for all rules, or for all rules in this category (Reliability).</span></span> <span data-ttu-id="66a2b-143">Para obter mais informações, consulte [Opções de configuração de regra de qualidade de código](../code-quality-rule-options.md).</span><span class="sxs-lookup"><span data-stu-id="66a2b-143">For more information, see [Code quality rule configuration options](../code-quality-rule-options.md).</span></span>

[!INCLUDE[excluded-symbol-names](~/includes/code-analysis/excluded-symbol-names.md)]

[!INCLUDE[excluded-type-names-with-derived-types](~/includes/code-analysis/excluded-type-names-with-derived-types.md)]

## <a name="related-rules"></a><span data-ttu-id="66a2b-144">Regras relacionadas</span><span class="sxs-lookup"><span data-stu-id="66a2b-144">Related rules</span></span>

- [<span data-ttu-id="66a2b-145">CA2213: Campos descartáveis devem ser descartados</span><span class="sxs-lookup"><span data-stu-id="66a2b-145">CA2213: Disposable fields should be disposed</span></span>](ca2213.md)

## <a name="example-1"></a><span data-ttu-id="66a2b-146">Exemplo 1</span><span class="sxs-lookup"><span data-stu-id="66a2b-146">Example 1</span></span>

<span data-ttu-id="66a2b-147">Se você estiver implementando um método que retorna um objeto descartável, use um bloco try/finally sem um bloco catch para certificar-se de que o objeto foi Descartado.</span><span class="sxs-lookup"><span data-stu-id="66a2b-147">If you're implementing a method that returns a disposable object, use a try/finally block without a catch block to make sure that the object is disposed.</span></span> <span data-ttu-id="66a2b-148">Usando um bloco try/finally, você permite que exceções sejam geradas no ponto de falha e certifique-se de que o objeto seja Descartado.</span><span class="sxs-lookup"><span data-stu-id="66a2b-148">By using a try/finally block, you allow exceptions to be raised at the fault point and make sure that object is disposed.</span></span>

<span data-ttu-id="66a2b-149">No método OpenPort1, a chamada para abrir o objeto ISerializable SerialPort ou a chamada para SomeMethod pode falhar.</span><span class="sxs-lookup"><span data-stu-id="66a2b-149">In the OpenPort1 method, the call to open the ISerializable object SerialPort or the call to SomeMethod can fail.</span></span> <span data-ttu-id="66a2b-150">Um aviso CA2000 é gerado nessa implementação.</span><span class="sxs-lookup"><span data-stu-id="66a2b-150">A CA2000 warning is raised on this implementation.</span></span>

<span data-ttu-id="66a2b-151">No método OpenPort2, dois objetos SerialPort são declarados e definidos como NULL:</span><span class="sxs-lookup"><span data-stu-id="66a2b-151">In the OpenPort2 method, two SerialPort objects are declared and set to null:</span></span>

- <span data-ttu-id="66a2b-152">`tempPort`, que é usado para testar se as operações do método são bem-sucedidos.</span><span class="sxs-lookup"><span data-stu-id="66a2b-152">`tempPort`, which is used to test that the method operations succeed.</span></span>

- <span data-ttu-id="66a2b-153">`port`, que é usado para o valor de retorno do método.</span><span class="sxs-lookup"><span data-stu-id="66a2b-153">`port`, which is used for the return value of the method.</span></span>

<span data-ttu-id="66a2b-154">O `tempPort` é construído e aberto em um `try` bloco, e qualquer outro trabalho necessário é executado no mesmo `try` bloco.</span><span class="sxs-lookup"><span data-stu-id="66a2b-154">The `tempPort` is constructed and opened in a `try` block, and any other required work is performed in the same `try` block.</span></span> <span data-ttu-id="66a2b-155">No final do `try` bloco, a porta aberta é atribuída ao `port` objeto que será retornado e o `tempPort` objeto será definido como `null` .</span><span class="sxs-lookup"><span data-stu-id="66a2b-155">At the end of the `try` block, the opened port is assigned to the `port` object that will be returned and the `tempPort` object is set to `null`.</span></span>

<span data-ttu-id="66a2b-156">O `finally` bloco verifica o valor de `tempPort` .</span><span class="sxs-lookup"><span data-stu-id="66a2b-156">The `finally` block checks the value of `tempPort`.</span></span> <span data-ttu-id="66a2b-157">Se não for NULL, uma operação no método terá falhado e `tempPort` será fechada para garantir que todos os recursos sejam liberados.</span><span class="sxs-lookup"><span data-stu-id="66a2b-157">If it is not null, an operation in the method has failed, and `tempPort` is closed to make sure that any resources are released.</span></span> <span data-ttu-id="66a2b-158">O objeto de porta retornado conterá o objeto SerialPort aberto se as operações do método tiverem êxito ou serão nulas se uma operação falhar.</span><span class="sxs-lookup"><span data-stu-id="66a2b-158">The returned port object will contain the opened SerialPort object if the operations of the method succeeded, or it will be null if an operation failed.</span></span>

```csharp
public SerialPort OpenPort1(string portName)
{
   SerialPort port = new SerialPort(portName);
   port.Open();  //CA2000 fires because this might throw
   SomeMethod(); //Other method operations can fail
   return port;
}

public SerialPort OpenPort2(string portName)
{
   SerialPort tempPort = null;
   SerialPort port = null;
   try
   {
      tempPort = new SerialPort(portName);
      tempPort.Open();
      SomeMethod();
      //Add any other methods above this line
      port = tempPort;
      tempPort = null;

   }
   finally
   {
      if (tempPort != null)
      {
         tempPort.Close();
      }
   }
   return port;
}
```

```vb
Public Function OpenPort1(ByVal PortName As String) As SerialPort

   Dim port As New SerialPort(PortName)
   port.Open()    'CA2000 fires because this might throw
   SomeMethod()   'Other method operations can fail
   Return port

End Function

Public Function OpenPort2(ByVal PortName As String) As SerialPort

   Dim tempPort As SerialPort = Nothing
   Dim port As SerialPort = Nothing

   Try
      tempPort = New SerialPort(PortName)
      tempPort.Open()
      SomeMethod()
      'Add any other methods above this line
      port = tempPort
      tempPort = Nothing

   Finally
      If Not tempPort Is Nothing Then
         tempPort.Close()
      End If

   End Try

   Return port

End Function
```

## <a name="example-2"></a><span data-ttu-id="66a2b-159">Exemplo 2</span><span class="sxs-lookup"><span data-stu-id="66a2b-159">Example 2</span></span>

<span data-ttu-id="66a2b-160">Por padrão, o compilador Visual Basic tem todos os operadores aritméticos verificam o estouro.</span><span class="sxs-lookup"><span data-stu-id="66a2b-160">By default, the Visual Basic compiler has all arithmetic operators check for overflow.</span></span> <span data-ttu-id="66a2b-161">Portanto, qualquer Visual Basic operação aritmética pode gerar um <xref:System.OverflowException> .</span><span class="sxs-lookup"><span data-stu-id="66a2b-161">Therefore, any Visual Basic arithmetic operation might throw an <xref:System.OverflowException>.</span></span> <span data-ttu-id="66a2b-162">Isso pode levar a violações inesperadas em regras como CA2000.</span><span class="sxs-lookup"><span data-stu-id="66a2b-162">This could lead to unexpected violations in rules such as CA2000.</span></span> <span data-ttu-id="66a2b-163">Por exemplo, a seguinte função CreateReader1 produzirá uma violação de CA2000, pois o compilador de Visual Basic está emitindo uma instrução de verificação de estouro para a adição que poderia gerar uma exceção que faria com que StreamReader não fosse descartado.</span><span class="sxs-lookup"><span data-stu-id="66a2b-163">For example, the following CreateReader1 function will produce a CA2000 violation because the Visual Basic compiler is emitting an overflow checking instruction for the addition that could throw an exception that would cause the StreamReader not to be disposed.</span></span>

<span data-ttu-id="66a2b-164">Para corrigir isso, você pode desabilitar a emissão de verificações de estouro pelo compilador Visual Basic em seu projeto ou pode modificar seu código como na seguinte função CreateReader2.</span><span class="sxs-lookup"><span data-stu-id="66a2b-164">To fix this, you can disable the emitting of overflow checks by the Visual Basic compiler in your project or you can modify your code as in the following CreateReader2 function.</span></span>

<span data-ttu-id="66a2b-165">Para desabilitar a emissão de verificações de estouro, clique com o botão direito do mouse no nome do projeto em Gerenciador de Soluções e clique em **Propriedades**.</span><span class="sxs-lookup"><span data-stu-id="66a2b-165">To disable the emitting of overflow checks, right-click the project name in Solution Explorer and then click **Properties**.</span></span> <span data-ttu-id="66a2b-166">Clique em **Compilar**, clique em **Opções de compilação avançadas** e marque **Remover verificações de estouro de inteiro**.</span><span class="sxs-lookup"><span data-stu-id="66a2b-166">Click **Compile**, click **Advanced Compile Options**, and then check **Remove integer overflow checks**.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca2000-dispose-objects-before-losing-scope-vboverflow_1.vb":::

## <a name="see-also"></a><span data-ttu-id="66a2b-167">Confira também</span><span class="sxs-lookup"><span data-stu-id="66a2b-167">See also</span></span>

- <xref:System.IDisposable>
- [<span data-ttu-id="66a2b-168">Padrão de descarte</span><span class="sxs-lookup"><span data-stu-id="66a2b-168">Dispose Pattern</span></span>](../../../standard/garbage-collection/implementing-dispose.md)
