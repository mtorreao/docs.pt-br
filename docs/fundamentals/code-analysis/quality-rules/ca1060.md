---
title: 'CA1060: mover P-invoca para a classe NativeMethods (análise de código)'
description: 'Saiba mais sobre a regra de análise de código CA1060: mover P-invoca para a classe NativeMethods'
ms.date: 11/04/2016
ms.topic: reference
f1_keywords:
- MovePInvokesToNativeMethodsClass
- CA1060
helpviewer_keywords:
- MovePInvokesToNativeMethodsClass
- CA1060
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
- VB
ms.openlocfilehash: bc96c1b2d463a95ff5c5f61fc4642411cc6bca3b
ms.sourcegitcommit: a6bd4cad438fe479cbd112eae10f2cd449f06e40
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/08/2020
ms.locfileid: "96585124"
---
# <a name="ca1060-move-pinvokes-to-nativemethods-class"></a><span data-ttu-id="400f3-103">CA1060: mover P/Invokes para a classe NativeMethods</span><span class="sxs-lookup"><span data-stu-id="400f3-103">CA1060: Move P/Invokes to NativeMethods class</span></span>

| | <span data-ttu-id="400f3-104">Valor</span><span class="sxs-lookup"><span data-stu-id="400f3-104">Value</span></span> |
|-|-|
| <span data-ttu-id="400f3-105">**ID da regra**</span><span class="sxs-lookup"><span data-stu-id="400f3-105">**Rule ID**</span></span> |<span data-ttu-id="400f3-106">CA1060</span><span class="sxs-lookup"><span data-stu-id="400f3-106">CA1060</span></span>|
| <span data-ttu-id="400f3-107">**Categoria**</span><span class="sxs-lookup"><span data-stu-id="400f3-107">**Category**</span></span> |<span data-ttu-id="400f3-108">Microsoft. Design</span><span class="sxs-lookup"><span data-stu-id="400f3-108">Microsoft.Design</span></span>|
| <span data-ttu-id="400f3-109">**A correção está sendo interrompida ou não está sendo interrompida**</span><span class="sxs-lookup"><span data-stu-id="400f3-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="400f3-110">Quebra</span><span class="sxs-lookup"><span data-stu-id="400f3-110">Breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="400f3-111">Causa</span><span class="sxs-lookup"><span data-stu-id="400f3-111">Cause</span></span>

<span data-ttu-id="400f3-112">Um método usa serviços de invocação de plataforma para acessar código não gerenciado e não é membro de uma das classes **NativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="400f3-112">A method uses Platform Invocation Services to access unmanaged code and is not a member of one of the **NativeMethods** classes.</span></span>

## <a name="rule-description"></a><span data-ttu-id="400f3-113">Descrição da regra</span><span class="sxs-lookup"><span data-stu-id="400f3-113">Rule description</span></span>

<span data-ttu-id="400f3-114">Métodos de invocação de plataforma, como aqueles que são marcados usando o <xref:System.Runtime.InteropServices.DllImportAttribute?displayProperty=fullName> atributo ou métodos que são definidos usando a `Declare` palavra-chave em Visual Basic, acessam código não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="400f3-114">Platform Invocation methods, such as those that are marked by using the <xref:System.Runtime.InteropServices.DllImportAttribute?displayProperty=fullName> attribute, or methods that are defined by using the `Declare` keyword in Visual Basic, access unmanaged code.</span></span> <span data-ttu-id="400f3-115">Esses métodos devem estar em uma das seguintes classes:</span><span class="sxs-lookup"><span data-stu-id="400f3-115">These methods should be in one of the following classes:</span></span>

- <span data-ttu-id="400f3-116">**NativeMethods** -essa classe não suprime as movimentações de pilha para a permissão de código não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="400f3-116">**NativeMethods** - This class does not suppress stack walks for unmanaged code permission.</span></span> <span data-ttu-id="400f3-117">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> não deve ser aplicado a esta classe.) Essa classe é para métodos que podem ser usados em qualquer lugar, pois uma movimentação de pilha será executada.</span><span class="sxs-lookup"><span data-stu-id="400f3-117">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> must not be applied to this class.) This class is for methods that can be used anywhere because a stack walk will be performed.</span></span>

- <span data-ttu-id="400f3-118">**SafeNativeMethods** -essa classe suprime as movimentações de pilha para a permissão de código não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="400f3-118">**SafeNativeMethods** - This class suppresses stack walks for unmanaged code permission.</span></span> <span data-ttu-id="400f3-119">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> é aplicado a esta classe.) Essa classe é para métodos que são seguros para qualquer pessoa chamar.</span><span class="sxs-lookup"><span data-stu-id="400f3-119">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> is applied to this class.) This class is for methods that are safe for anyone to call.</span></span> <span data-ttu-id="400f3-120">Os chamadores desses métodos não são necessários para executar uma revisão de segurança completa para garantir que o uso seja seguro, pois os métodos são inofensivos para qualquer chamador.</span><span class="sxs-lookup"><span data-stu-id="400f3-120">Callers of these methods are not required to perform a full security review to make sure that the usage is secure because the methods are harmless for any caller.</span></span>

- <span data-ttu-id="400f3-121">**UnsafeNativeMethods** -essa classe suprime as movimentações de pilha para a permissão de código não gerenciado.</span><span class="sxs-lookup"><span data-stu-id="400f3-121">**UnsafeNativeMethods** - This class suppresses stack walks for unmanaged code permission.</span></span> <span data-ttu-id="400f3-122">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> é aplicado a esta classe.) Essa classe é para métodos que são potencialmente perigosos.</span><span class="sxs-lookup"><span data-stu-id="400f3-122">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> is applied to this class.) This class is for methods that are potentially dangerous.</span></span> <span data-ttu-id="400f3-123">Qualquer chamador desses métodos deve executar uma revisão de segurança completa para garantir que o uso seja seguro, pois nenhuma movimentação de pilha será executada.</span><span class="sxs-lookup"><span data-stu-id="400f3-123">Any caller of these methods must perform a full security review to make sure that the usage is secure because no stack walk will be performed.</span></span>

<span data-ttu-id="400f3-124">Essas classes são declaradas como `internal` ( `Friend` em Visual Basic) e declaram um Construtor privado para impedir que novas instâncias sejam criadas.</span><span class="sxs-lookup"><span data-stu-id="400f3-124">These classes are declared as `internal` (`Friend` in Visual Basic) and declare a private constructor to prevent new instances from being created.</span></span> <span data-ttu-id="400f3-125">Os métodos nessas classes devem ser `static` e `internal` ( `Shared` e `Friend` em Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="400f3-125">The methods in these classes should be `static` and `internal` (`Shared` and `Friend` in Visual Basic).</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="400f3-126">Como corrigir violações</span><span class="sxs-lookup"><span data-stu-id="400f3-126">How to fix violations</span></span>

<span data-ttu-id="400f3-127">Para corrigir uma violação dessa regra, mova o método para a classe **NativeMethods** apropriada.</span><span class="sxs-lookup"><span data-stu-id="400f3-127">To fix a violation of this rule, move the method to the appropriate **NativeMethods** class.</span></span> <span data-ttu-id="400f3-128">Para a maioria dos aplicativos, mover P/Invokes para uma nova classe denominada **NativeMethods** é suficiente.</span><span class="sxs-lookup"><span data-stu-id="400f3-128">For most applications, moving P/Invokes to a new class that is named **NativeMethods** is enough.</span></span>

<span data-ttu-id="400f3-129">No entanto, se você estiver desenvolvendo bibliotecas para uso em outros aplicativos, considere definir duas outras classes que são chamadas **SafeNativeMethods** e **UnsafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="400f3-129">However, if you are developing libraries for use in other applications, you should consider defining two other classes that are called **SafeNativeMethods** and **UnsafeNativeMethods**.</span></span> <span data-ttu-id="400f3-130">Essas classes se assemelham à classe **NativeMethods** ; no entanto, elas são marcadas usando um atributo especial chamado **SuppressUnmanagedCodeSecurityAttribute**.</span><span class="sxs-lookup"><span data-stu-id="400f3-130">These classes resemble the **NativeMethods** class; however, they are marked by using a special attribute called **SuppressUnmanagedCodeSecurityAttribute**.</span></span> <span data-ttu-id="400f3-131">Quando esse atributo é aplicado, o tempo de execução não executa uma movimentação de pilha completa para garantir que todos os chamadores tenham a permissão **UnmanagedCode** .</span><span class="sxs-lookup"><span data-stu-id="400f3-131">When this attribute is applied, the runtime does not perform a full stack walk to make sure that all callers have the **UnmanagedCode** permission.</span></span> <span data-ttu-id="400f3-132">O tempo de execução normalmente verifica essa permissão na inicialização.</span><span class="sxs-lookup"><span data-stu-id="400f3-132">The runtime ordinarily checks for this permission at startup.</span></span> <span data-ttu-id="400f3-133">Como a verificação não é executada, ela pode melhorar muito o desempenho de chamadas para esses métodos não gerenciados, além de permitir o código que tem permissões limitadas para chamar esses métodos.</span><span class="sxs-lookup"><span data-stu-id="400f3-133">Because the check is not performed, it can greatly improve performance for calls to these unmanaged methods, It also enables code that has limited permissions to call these methods.</span></span>

<span data-ttu-id="400f3-134">No entanto, você deve usar esse atributo com muito cuidado.</span><span class="sxs-lookup"><span data-stu-id="400f3-134">However, you should use this attribute with great care.</span></span> <span data-ttu-id="400f3-135">Ela poderá ter implicações de segurança sérias se ela for implementada incorretamente.</span><span class="sxs-lookup"><span data-stu-id="400f3-135">It can have serious security implications if it is implemented incorrectly..</span></span>

<span data-ttu-id="400f3-136">Para obter informações sobre como implementar os métodos, consulte o exemplo de **NativeMethods** , o exemplo de **SafeNativeMethods** e o exemplo de **UnsafeNativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="400f3-136">For information about how to implement the methods, see the **NativeMethods** example, **SafeNativeMethods** example, and **UnsafeNativeMethods** example.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="400f3-137">Quando suprimir avisos</span><span class="sxs-lookup"><span data-stu-id="400f3-137">When to suppress warnings</span></span>

<span data-ttu-id="400f3-138">Não suprima um aviso nessa regra.</span><span class="sxs-lookup"><span data-stu-id="400f3-138">Do not suppress a warning from this rule.</span></span>

## <a name="example"></a><span data-ttu-id="400f3-139">Exemplo</span><span class="sxs-lookup"><span data-stu-id="400f3-139">Example</span></span>

<span data-ttu-id="400f3-140">O exemplo a seguir declara um método que viola essa regra.</span><span class="sxs-lookup"><span data-stu-id="400f3-140">The following example declares a method that violates this rule.</span></span> <span data-ttu-id="400f3-141">Para corrigir a violação, o **RemoveDirectory** P/Invoke deve ser movido para uma classe apropriada que foi projetada para manter apenas P/Invokes.</span><span class="sxs-lookup"><span data-stu-id="400f3-141">To correct the violation, the **RemoveDirectory** P/Invoke should be moved to an appropriate class that is designed to hold only P/Invokes.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet1":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet1":::

## <a name="nativemethods-example"></a><span data-ttu-id="400f3-142">Exemplo de NativeMethods</span><span class="sxs-lookup"><span data-stu-id="400f3-142">NativeMethods example</span></span>

<span data-ttu-id="400f3-143">Como a classe **NativeMethods** não deve ser marcada usando **SuppressUnmanagedCodeSecurityAttribute**, P/Invokes que são colocados nela exigirão permissão **UnmanagedCode** .</span><span class="sxs-lookup"><span data-stu-id="400f3-143">Because the **NativeMethods** class should not be marked by using **SuppressUnmanagedCodeSecurityAttribute**, P/Invokes that are put in it will require **UnmanagedCode** permission.</span></span> <span data-ttu-id="400f3-144">Como a maioria dos aplicativos é executada a partir do computador local e executada com confiança total, normalmente isso não é um problema.</span><span class="sxs-lookup"><span data-stu-id="400f3-144">Because most applications run from the local computer and run together with full trust, this is usually not a problem.</span></span> <span data-ttu-id="400f3-145">No entanto, se você estiver desenvolvendo bibliotecas reutilizáveis, considere definir uma classe **SafeNativeMethods** ou **UnsafeNativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="400f3-145">However, if you are developing reusable libraries, you should consider defining a **SafeNativeMethods** or **UnsafeNativeMethods** class.</span></span>

<span data-ttu-id="400f3-146">O exemplo a seguir mostra um método de **interação. Beep** que encapsula a função **MessageBeep** de user32.dll.</span><span class="sxs-lookup"><span data-stu-id="400f3-146">The following example shows an **Interaction.Beep** method that wraps the **MessageBeep** function from user32.dll.</span></span> <span data-ttu-id="400f3-147">O P/Invoke **MessageBeep** é colocado na classe **NativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="400f3-147">The **MessageBeep** P/Invoke is put in the **NativeMethods** class.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet2":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet2":::

## <a name="safenativemethods-example"></a><span data-ttu-id="400f3-148">Exemplo de SafeNativeMethods</span><span class="sxs-lookup"><span data-stu-id="400f3-148">SafeNativeMethods example</span></span>

<span data-ttu-id="400f3-149">Os métodos P/Invoke que podem ser expostos com segurança a qualquer aplicativo e que não têm nenhum efeito colateral devem ser colocados em uma classe denominada **SafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="400f3-149">P/Invoke methods that can be safely exposed to any application and that do not have any side effects should be put in a class that is named **SafeNativeMethods**.</span></span> <span data-ttu-id="400f3-150">Você não precisa solicitar permissões e não precisa pagar muita atenção para onde elas são chamadas.</span><span class="sxs-lookup"><span data-stu-id="400f3-150">You do not have to demand permissions and you do not have to pay much attention to where they are called from.</span></span>

<span data-ttu-id="400f3-151">O exemplo a seguir mostra uma propriedade **Environment.** semique encapsula a função **ObterContagemMarcaEscala** de kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="400f3-151">The following example shows an **Environment.TickCount** property that wraps the **GetTickCount** function from kernel32.dll.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet3":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet3":::

## <a name="unsafenativemethods-example"></a><span data-ttu-id="400f3-152">Exemplo de UnsafeNativeMethods</span><span class="sxs-lookup"><span data-stu-id="400f3-152">UnsafeNativeMethods example</span></span>

<span data-ttu-id="400f3-153">Métodos P/Invoke que não podem ser chamados com segurança e que podem causar efeitos colaterais devem ser colocados em uma classe denominada **UnsafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="400f3-153">P/Invoke methods that cannot be safely called and that could cause side effects should be put in a class that is named **UnsafeNativeMethods**.</span></span> <span data-ttu-id="400f3-154">Esses métodos devem ser verificados rigorosamente para garantir que eles não sejam expostos ao usuário involuntariamente.</span><span class="sxs-lookup"><span data-stu-id="400f3-154">These methods should be rigorously checked to make sure that they are not exposed to the user unintentionally.</span></span> <span data-ttu-id="400f3-155">Como alternativa, os métodos devem ter outra permissão exigida em vez de **UnmanagedCode** ao usá-los.</span><span class="sxs-lookup"><span data-stu-id="400f3-155">Alternatively, the methods should have another permission that is demanded instead of **UnmanagedCode** when they use them.</span></span>

<span data-ttu-id="400f3-156">O exemplo a seguir mostra um método **cursor. Hide** que encapsula a função de " **addcursor** " de user32.dll.</span><span class="sxs-lookup"><span data-stu-id="400f3-156">The following example shows a **Cursor.Hide** method that wraps the **ShowCursor** function from user32.dll.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet4":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet4":::

## <a name="see-also"></a><span data-ttu-id="400f3-157">Confira também</span><span class="sxs-lookup"><span data-stu-id="400f3-157">See also</span></span>

- [<span data-ttu-id="400f3-158">Regras de design</span><span class="sxs-lookup"><span data-stu-id="400f3-158">Design rules</span></span>](design-warnings.md)
