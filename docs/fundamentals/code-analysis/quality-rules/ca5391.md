---
title: 'CA5391: usar tokens antifalsificação em controladores MVC ASP.NET Core (análise de código)'
description: Fornece informações sobre a regra de análise de código CA5391, incluindo causas, como corrigir violações e quando suprimir.
ms.date: 05/27/2020
ms.topic: reference
author: LLLXXXCCC
ms.author: linche
f1_keywords:
- CA5391
ms.openlocfilehash: 38168b78c40bc19962afa714a046be282a690558
ms.sourcegitcommit: e301979e3049ce412d19b094c60ed95b316a8f8c
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/16/2020
ms.locfileid: "97594248"
---
# <a name="ca5391-use-antiforgery-tokens-in-aspnet-core-mvc-controllers"></a><span data-ttu-id="1da18-103">CA5391: Usar tokens antifalsificação em controladores MVC do ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="1da18-103">CA5391: Use antiforgery tokens in ASP.NET Core MVC controllers</span></span>

| | <span data-ttu-id="1da18-104">Valor</span><span class="sxs-lookup"><span data-stu-id="1da18-104">Value</span></span> |
|-|-|
| <span data-ttu-id="1da18-105">**ID da regra**</span><span class="sxs-lookup"><span data-stu-id="1da18-105">**Rule ID**</span></span> |<span data-ttu-id="1da18-106">CA5391</span><span class="sxs-lookup"><span data-stu-id="1da18-106">CA5391</span></span>|
| <span data-ttu-id="1da18-107">**Categoria**</span><span class="sxs-lookup"><span data-stu-id="1da18-107">**Category**</span></span> |<span data-ttu-id="1da18-108">Microsoft.Security</span><span class="sxs-lookup"><span data-stu-id="1da18-108">Microsoft.Security</span></span>|
| <span data-ttu-id="1da18-109">**A correção está sendo interrompida ou não está sendo interrompida**</span><span class="sxs-lookup"><span data-stu-id="1da18-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="1da18-110">Sem interrupção</span><span class="sxs-lookup"><span data-stu-id="1da18-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="1da18-111">Causa</span><span class="sxs-lookup"><span data-stu-id="1da18-111">Cause</span></span>

<span data-ttu-id="1da18-112">As ações que resultam em operações de modificação não têm um atributo de token de antifalsificação.</span><span class="sxs-lookup"><span data-stu-id="1da18-112">Actions that result in modifying operations don't have an antiforgery token attribute.</span></span> <span data-ttu-id="1da18-113">Ou, usando um filtro de token antifalsificação global sem chamar funções de token antipiratade esperadas.</span><span class="sxs-lookup"><span data-stu-id="1da18-113">Or, using a global antiforgery token filter without calling expected anti forgery token functions.</span></span>

## <a name="rule-description"></a><span data-ttu-id="1da18-114">Descrição da regra</span><span class="sxs-lookup"><span data-stu-id="1da18-114">Rule description</span></span>

<span data-ttu-id="1da18-115">Manipular uma `POST` `PUT` solicitação,, `PATCH` ou `DELETE` sem validar um token de antifalsificação pode estar vulnerável a ataques de solicitação entre sites forjada.</span><span class="sxs-lookup"><span data-stu-id="1da18-115">Handling a `POST`, `PUT`, `PATCH`, or `DELETE` request without validating an antiforgery token may be vulnerable to cross-site request forgery attacks.</span></span> <span data-ttu-id="1da18-116">Um ataque de falsificação de solicitação entre sites pode enviar solicitações mal-intencionadas de um usuário autenticado para seu controlador ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="1da18-116">A cross-site request forgery attack can send malicious requests from an authenticated user to your ASP.NET Core MVC controller.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="1da18-117">Como corrigir violações</span><span class="sxs-lookup"><span data-stu-id="1da18-117">How to fix violations</span></span>

- <span data-ttu-id="1da18-118">Marque a ação de modificação com um atributo de token de antifalsificação válido:</span><span class="sxs-lookup"><span data-stu-id="1da18-118">Mark the modifying action with a valid antiforgery token attribute:</span></span>
  - <span data-ttu-id="1da18-119"><xref:Microsoft.AspNetCore.Mvc.ValidateAntiForgeryTokenAttribute?displayProperty=fullName>.</span><span class="sxs-lookup"><span data-stu-id="1da18-119"><xref:Microsoft.AspNetCore.Mvc.ValidateAntiForgeryTokenAttribute?displayProperty=fullName>.</span></span>
  - <span data-ttu-id="1da18-120">Atributo cujo nome é like `%Validate%Anti_orgery%Attribute` .</span><span class="sxs-lookup"><span data-stu-id="1da18-120">Attribute whose name is like `%Validate%Anti_orgery%Attribute`.</span></span>
- <span data-ttu-id="1da18-121">Adicione o atributo de token forjado válido ao filtro global com <xref:Microsoft.AspNetCore.Mvc.Filters.FilterCollection.Add%2A?displayProperty=fullName> .</span><span class="sxs-lookup"><span data-stu-id="1da18-121">Add the valid forgery token attribute into the global filter with <xref:Microsoft.AspNetCore.Mvc.Filters.FilterCollection.Add%2A?displayProperty=fullName>.</span></span>
- <span data-ttu-id="1da18-122">Adicione qualquer classe de filtro antifalsificação personalizada ou fornecida pelo MVC que chame `Validate` em qualquer classe que implemente a <xref:Microsoft.AspNetCore.Antiforgery.IAntiforgery?displayProperty=fullName> interface.</span><span class="sxs-lookup"><span data-stu-id="1da18-122">Add any custom or Mvc-provided antiforgery filter class that calls `Validate` on any class that implements the <xref:Microsoft.AspNetCore.Antiforgery.IAntiforgery?displayProperty=fullName> interface.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="1da18-123">Quando suprimir avisos</span><span class="sxs-lookup"><span data-stu-id="1da18-123">When to suppress warnings</span></span>

<span data-ttu-id="1da18-124">É seguro suprimir essa regra se as soluções que não usam atributos de token antifalsificação forem adotadas para atenuar vulnerabilidades de CSRF.</span><span class="sxs-lookup"><span data-stu-id="1da18-124">It's safe to suppress this rule if solutions other than using antiforgery token attributes are adopted to mitigate CSRF vulnerabilities.</span></span> <span data-ttu-id="1da18-125">Para obter mais informações, consulte [evitar ataques de solicitação intersite forjada (XSRF/CSRF) no ASP.NET Core](/aspnet/core/security/anti-request-forgery).</span><span class="sxs-lookup"><span data-stu-id="1da18-125">For more information, see [Prevent Cross-Site Request Forgery (XSRF/CSRF) attacks in ASP.NET Core](/aspnet/core/security/anti-request-forgery).</span></span>

## <a name="configure-code-to-analyze"></a><span data-ttu-id="1da18-126">Configurar o código para analisar</span><span class="sxs-lookup"><span data-stu-id="1da18-126">Configure code to analyze</span></span>

<span data-ttu-id="1da18-127">Você pode configurar se a regra se aplica somente a classes derivadas de <xref:Microsoft.AspNetCore.Mvc.Controller?displayProperty=fullName> na sua base de código.</span><span class="sxs-lookup"><span data-stu-id="1da18-127">You can configure whether the rule applies only to derived classes of <xref:Microsoft.AspNetCore.Mvc.Controller?displayProperty=fullName> in your codebase.</span></span> <span data-ttu-id="1da18-128">Por exemplo, para especificar que a regra não deve ser executada em nenhum código dentro de tipos derivados de <xref:Microsoft.AspNetCore.Mvc.ControllerBase> , adicione o seguinte par chave-valor a um arquivo *. editorconfig* em seu projeto:</span><span class="sxs-lookup"><span data-stu-id="1da18-128">For example, to specify that the rule should not run on any code within derived types of <xref:Microsoft.AspNetCore.Mvc.ControllerBase>, add the following key-value pair to an *.editorconfig* file in your project:</span></span>

```ini
dotnet_code_quality.CA5391.exclude_aspnet_core_mvc_controllerbase = true
```

## <a name="pseudo-code-examples"></a><span data-ttu-id="1da18-129">Exemplos de pseudocódigo</span><span class="sxs-lookup"><span data-stu-id="1da18-129">Pseudo-code examples</span></span>

### <a name="without-anti-forgery-token-attribute-violation"></a><span data-ttu-id="1da18-130">Sem violação de atributo de token antifalsificação</span><span class="sxs-lookup"><span data-stu-id="1da18-130">Without anti forgery token attribute violation</span></span>

```csharp
using Microsoft.AspNetCore.Mvc;

class ExampleController : Controller
{
    [HttpDelete]
    public IActionResult ExampleAction (string actionName)
    {
        return null;
    }

    [ValidateAntiForgeryToken]
    [HttpDelete]
    public IActionResult AnotherAction (string actionName)
    {
        return null;
    }
}
```

### <a name="without-valid-global-anti-forgery-filter"></a><span data-ttu-id="1da18-131">Sem um filtro antifalsificação global válido</span><span class="sxs-lookup"><span data-stu-id="1da18-131">Without valid global anti forgery filter</span></span>

```csharp
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

class ExampleController : Controller
{
    [ValidateAntiForgeryToken]
    [HttpDelete]
    public IActionResult AnotherAction (string actionName)
    {
        return null;
    }

    [HttpDelete]
    public IActionResult ExampleAction (string actionName)
    {
        return null;
    }
}

class FilterClass : IAsyncAuthorizationFilter
{
    public Task OnAuthorizationAsync (AuthorizationFilterContext context)
    {
        return null;
    }
}

class BlahClass
{
    public static void BlahMethod ()
    {
        FilterCollection filterCollection = new FilterCollection ();
        filterCollection.Add(typeof(FilterClass));
    }
}
```

### <a name="marked-with-an-anti-forgery-token-attribute-solution"></a><span data-ttu-id="1da18-132">Marcado com uma solução de atributo de token antifalsificação</span><span class="sxs-lookup"><span data-stu-id="1da18-132">Marked with an anti forgery token attribute solution</span></span>

```csharp
using Microsoft.AspNetCore.Mvc;

class ExampleController : Controller
{
    [ValidateAntiForgeryToken]
    [HttpDelete]
    public IActionResult ExampleAction ()
    {
        return null;
    }

    [ValidateAntiForgeryToken]
    [HttpDelete]
    public IActionResult AnotherAction ()
    {
        return null;
    }
}
```

### <a name="using-an-valid-global-anti-forgery-filter"></a><span data-ttu-id="1da18-133">Usando um filtro antifalsificação global válido</span><span class="sxs-lookup"><span data-stu-id="1da18-133">Using an valid global anti forgery filter</span></span>

```csharp
using System.Threading.Tasks;
using Microsoft.AspNetCore.Antiforgery;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

class ExampleController : Controller
{
    [ValidateAntiForgeryToken]
    [HttpDelete]
    public IActionResult AnotherAction()
    {
        return null;
    }

    [HttpDelete]
    public IActionResult ExampleAction()
    {
        return null;
    }
}

class FilterClass : IAsyncAuthorizationFilter
{
    private readonly IAntiforgery antiforgery;

    public FilterClass(IAntiforgery antiforgery)
    {
        this.antiforgery = antiforgery;
    }

    public Task OnAuthorizationAsync(AuthorizationFilterContext context)
    {
        return antiforgery.ValidateRequestAsync(context.HttpContext);
    }
}

class BlahClass
{
    public static void BlahMethod()
    {
        FilterCollection filterCollection = new FilterCollection();
        filterCollection.Add(typeof(FilterClass));
    }
}
```
